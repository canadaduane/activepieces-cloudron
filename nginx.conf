# /app/pkg/nginx.conf (Cloudron will place it here)

# Increase client_max_body_size if large uploads are expected (e.g., for pieces or data)
client_max_body_size 100m;

# Standard security headers (Cloudron might add some of these as well)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "SAMEORIGIN" always; # Good for preventing clickjacking
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Backend API and WebSocket handling
location ~ ^/(api/|socket\.io/) {
    proxy_pass http://localhost:3000; # Forward to the Node.js backend on httpPort
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Forwarded $proxy_add_forwarded;

    # For API calls, especially if they can be long-running or involve SSE
    proxy_buffering off;
    proxy_cache off; # Ensure fresh data from API
    proxy_read_timeout 900s; # Adjust if longer timeouts are needed
    proxy_send_timeout 900s;
}

# Serve static assets for the frontend
# Path should match where frontend assets are built into /app/code
# This path MUST be verified based on actual build output from ActivePieces.
# Common outputs are `dist/packages/ui` or `packages/ui/dist` or `dist/apps/ui` etc.
location / {
    root /app/code/dist/packages/ui; # VERIFY THIS PATH
    try_files $uri $uri/ /index.html?$args; # Standard SPA fallback

    # Add caching headers for static assets
    # Match common static file extensions
    location ~* \.(?:css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /app/code/dist/packages/ui; # VERIFY THIS PATH
        add_header Cache-Control "public, max-age=31536000, immutable";
        # `expires` is redundant if Cache-Control is set with max-age and immutable
        # access_log off; # Optional: disable access logging for static assets
    }
}

# Optional: Deny access to hidden files (e.g., .git, .env) if any were accidentally included
location ~ /\. {
    deny all;
}
